{"version":3,"sources":["../../../es6/dev/templating/parser.js"],"names":[],"mappings":"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","file":"parser.js","sourcesContent":["define('templating/parser',['module'], function(module) {\n    'use strict';\n\n    var buildMap = {},\n        srcMap = {},\n        idToSrc = {},\n        masterConfig = (module.config && module.config()) || {},\n        loadDependencies;\n\n    function traverse(o, func) {\n        for (var i in o) {\n            func.apply(this, [i, o[i]]);\n            if (o[i] !== null && typeof(o[i]) == \"object\") {\n                traverse(o[i], func);\n            }\n        }\n    }\n\n    function sourceMap(jsObject) {\n        let map = {}\n        traverse(jsObject, function(key, value) {\n            if (key == 'data' && value.src) {\n                map[value.src] = map[value.src] || [];\n                map[value.src].push(value);\n            }\n        });\n        return map;\n    }\n\n    /**\n     * Parses a resource name into its component parts. Resource names\n     * look like: module/name.ext\n     * @param {String} name the resource name\n     * @returns {Object} with properties \"moduleName\", \"ext\".\n     */\n    function parseName(name) {\n        let modName, ext, temp,\n            index = name.indexOf('.'),\n            isRelative = name.indexOf('./') === 0 ||\n                name.indexOf('../') === 0;\n\n        if (index !== -1 && (!isRelative || index > 1)) {\n            modName = name.substring(0, index);\n            ext = name.substring(index + 1, name.length);\n        } else {\n            modName = name;\n        }\n\n        temp = ext || modName;\n        index = temp.indexOf('!');\n        if (index !== -1) {\n            temp = temp.substring(0, index);\n            if (ext) {\n                ext = temp;\n            } else {\n                modName = temp;\n            }\n        }\n\n        return {\n            moduleName: modName,\n            ext:        ext\n        };\n    }\n\n    function finishLoad(Coder, content, name, onLoad, req) {\n        let coder = new Coder(content),\n            jsObject = buildMap[name] = coder.run(req.toUrl('./')),\n            map = srcMap[name] = sourceMap(jsObject),\n            sources = Object.keys(map);\n\n        req(sources, function(...args) {\n            if (masterConfig.isBuild) {\n                idToSrc[name] = {};\n                sources.forEach((src)=> {\n                    var id = Math.random();\n                    map[src].forEach((value)=> {\n                        value.src = id;\n                    });\n\n                    idToSrc[name][id] = src;\n                });\n\n            } else {\n                sources.forEach((src, index)=> {\n                    var obj = args[index];\n                    map[src].forEach(function(value) {\n                        value.src = obj;\n                    });\n                });\n            }\n            onLoad(jsObject);\n        });\n    }\n\n    if (masterConfig.env === 'node' || (!masterConfig.env && typeof process !== 'undefined' &&\n        process.versions && !!process.versions.node && !process.versions['node-webkit'])) {\n        //Using special require.nodeRequire, something added by r.js.\n        let fs = require.nodeRequire('fs');\n\n        loadDependencies = function(url, callback, errback) {\n            try {\n                var file = fs.readFileSync(url, 'utf8');\n                //Remove BOM (Byte Mark Order) from utf8 files if it is there.\n                if (file.indexOf('\\uFEFF') === 0) {\n                    file = file.substring(1);\n                }\n                callback(file);\n            } catch (e) {\n                if (errback) {\n                    errback(e);\n                }\n            }\n        };\n    } else if (masterConfig.env === 'xhr' || !masterConfig.env) {\n        loadDependencies = function(url, callback, errback, headers) {\n            let xhr = new XMLHttpRequest(),\n                header;\n            xhr.open('GET', url, true);\n\n            //Allow plugins direct access to xhr headers\n            if (headers) {\n                for (header in headers) {\n                    if (headers.hasOwnProperty(header)) {\n                        xhr.setRequestHeader(header.toLowerCase(), headers[header]);\n                    }\n                }\n            }\n\n            //Allow overrides specified in config\n            if (masterConfig.onXhr) {\n                masterConfig.onXhr(xhr, url);\n            }\n\n            xhr.onreadystatechange = function() {\n                let status, err;\n                //Do not explicitly handle errors, those should be\n                //visible via console output in the browser.\n                if (xhr.readyState === 4) {\n                    status = xhr.status || 0;\n                    if (status > 399 && status < 600) {\n                        //An http 4xx or 5xx error. Signal an error.\n                        err = new Error(url + ' HTTP status: ' + status);\n                        err.xhr = xhr;\n                        if (errback) {\n                            errback(err);\n                        }\n                    } else {\n                        callback(xhr.responseText);\n                    }\n\n                    if (masterConfig.onXhrComplete) {\n                        masterConfig.onXhrComplete(xhr, url);\n                    }\n                }\n            };\n            xhr.send(null);\n        };\n    }\n\n    return {\n        load (name, req, onLoad, config) {\n            masterConfig.isBuild = config && config.isBuild;\n            if (config) {\n                masterConfig.templateCoders = config.templateCoders || [];\n                masterConfig.templateDecoders = config.templateDecoders || [];\n            }\n\n            //Name has format: some.module.filext\n            let paths = {\n                    Coder: 'templating/Coder'\n                },\n                parsed = parseName(name),\n                nonStripName = parsed.moduleName + (parsed.ext ? '.' + parsed.ext : ''),\n                url = req.toUrl(nonStripName);\n\n            // Do not load if it is an empty: url\n            if (url.indexOf('empty:') === 0) {\n                onLoad();\n                return;\n            }\n\n            loadDependencies(url, function(content) {\n                if (masterConfig.isBuild) {\n                    let Coder = require.nodeRequire(require.toUrl(paths.Coder));\n                    masterConfig.templateCoders.forEach(function(coder) {\n                        Coder.addCoder(require.nodeRequire(require.toUrl(coder)));\n                    });\n                    finishLoad(Coder, content, name, onLoad, req);\n                } else {\n                    req([paths.Coder, ...masterConfig.templateCoders, ...masterConfig.templateDecoders], function(Coder) {\n                        finishLoad(Coder, content, name, onLoad, req);\n                    });\n                }\n            }, function(err) {\n                if (onLoad.error) {\n                    onLoad.error(err);\n                }\n            });\n        },\n\n        write (pluginName, moduleName, write) {\n\n            if (buildMap.hasOwnProperty(moduleName)) {\n                let content = JSON.stringify(buildMap[moduleName]),\n                    map = idToSrc[moduleName],\n                    ids = Object.keys(map),\n                    sources = [];\n                ids.forEach(function(id, i) {\n                    let re = new RegExp(id, 'g');\n                    content = content.replace(re, 'arguments[' + i + ']');\n                    sources.push(map[id]);\n                });\n\n                let dependencies = sources.concat(masterConfig.templateDecoders);\n\n                write.asModule(pluginName + '!' + moduleName,\n                    \"define(\" + JSON.stringify(dependencies) + \", function () { return \" +\n                    content +\n                    \";});\\n\");\n            }\n        }\n\n    };\n\n});\n"]}